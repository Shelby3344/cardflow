name: Deploy Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [master, main]

# Cancel in-progress deployments for the same PR
concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  deploy-preview:
    name: Deploy PR Preview
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Extract branch name
        shell: bash
        run: |
          echo "BRANCH_NAME=${GITHUB_HEAD_REF}" >> $GITHUB_ENV
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
      
      - name: Comment on PR - Deployment Starting
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ **Preview deployment starting...**\n\nBranch: `${{ env.BRANCH_NAME }}`\nCommit: `${{ github.sha }}`'
            })
      
      # This is a template - customize based on your hosting provider
      # Examples: Vercel, Netlify, Railway, Fly.io, AWS, etc.
      
      # Example for Railway
      # - name: Deploy to Railway
      #   uses: bervProject/railway-deploy@v1.1.0
      #   with:
      #     railway_token: ${{ secrets.RAILWAY_TOKEN }}
      #     service: cardflow-pr-${{ env.PR_NUMBER }}
      
      # Example for Vercel
      # - name: Deploy to Vercel
      #   uses: amondnet/vercel-action@v25
      #   with:
      #     vercel-token: ${{ secrets.VERCEL_TOKEN }}
      #     vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
      #     vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
      #     alias-domains: pr-${{ env.PR_NUMBER }}.cardflow-preview.vercel.app
      
      - name: Placeholder - Configure your deployment
        run: |
          echo "‚ö†Ô∏è Preview deployment workflow is configured but needs deployment provider setup"
          echo "Uncomment and configure one of the deployment steps above"
          echo ""
          echo "Supported providers:"
          echo "  - Vercel (Frontend)"
          echo "  - Railway (Full-stack)"
          echo "  - Fly.io (Docker)"
          echo "  - Netlify (Frontend)"
          echo "  - AWS/GCP/Azure (Custom)"
      
      - name: Comment on PR - Deployment Complete
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **Preview deployment ready!**\n\nüîó Configure deployment provider to get preview URL\n\n**Next steps:**\n1. Choose a hosting provider (Vercel, Railway, etc.)\n2. Add deployment secrets to repository\n3. Uncomment deployment step in `.github/workflows/preview.yml`'
            })
      
      - name: Comment on PR - Deployment Failed
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Preview deployment failed**\n\nCheck workflow logs for details.'
            })

  cleanup-preview:
    name: Cleanup Preview Environment
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    
    steps:
      - name: Cleanup preview environment
        run: |
          echo "Cleaning up preview environment for PR #${{ github.event.pull_request.number }}"
          # Add cleanup commands based on your provider
